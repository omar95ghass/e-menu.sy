# دليل استخدام منصة E-Menu (Usage Guide)

هذا المستند يشرح كيفية إعداد وتشغيل مشروع **E-Menu** على بيئة XAMPP أو أي خادم PHP تقليدي، وكيفية التأكد من أن الواجهة الأمامية والخلفية متكاملتان بشكل صحيح.

## 1. المتطلبات الأساسية (Prerequisites)
- PHP 8.0 أو أحدث مع تمكين ملحقات `mysqli` و`pdo_mysql`.
- خادم Apache (مثل XAMPP أو Laragon) مع تفعيل `mod_rewrite`.
- قاعدة بيانات MySQL أو MariaDB.
- متصفح حديث يدعم JavaScript.

## 2. تثبيت الخلفية (Backend Setup)
1. انسخ مجلد المشروع بالكامل إلى مجلد الاستضافة المحلي (على سبيل المثال `C:/xampp/htdocs/e-menu`).
2. أنشئ قاعدة بيانات جديدة باسم `e_menu` (أو أي اسم تختاره) واستورد ملف قاعدة البيانات `database/schema.sql`.
3. حدّث إعدادات الاتصال في `config/config.php` لتطابق بيانات الدخول إلى قاعدة البيانات، وقم بتعديل الثوابت `APP_URL` و`APP_SUBDOMAIN_BASE` إذا لزم الأمر. تأكد من ضبط كلمات المرور والسرية (`JWT_SECRET`) قبل النشر على بيئة حقيقية.
4. تأكد من أن Apache يقرأ ملف `.htaccess` المتوفر في جذر المشروع، حيث يفعّل إعادة كتابة الروابط لتوجيه جميع الطلبات نحو `api/index.php`.
5. فعّل خادم Apache وقاعدة البيانات من XAMPP، ثم زر `http://localhost/e-menu/` للتحقق من تحميل الصفحة الرئيسية.

## 3. إعداد الواجهة الأمامية (Frontend Behaviour)
- ملفات JavaScript الأساسية (`assets/js/app.js` و`assets/js/api.js`) تكتشف مسار التطبيق تلقائيًا استنادًا إلى موقع الملفات داخل الخادم، لذلك سيعمل الموقع سواء كان في الجذر أو داخل مجلد فرعي مثل `/e-menu`. لا حاجة لتعديل الروابط يدويًا؛ يتم بناء روابط API باستخدام الدالة العالمية `buildApiUrl`. 
- يتم تحميل العميل البرمجي `APIClient` تلقائيًا عند جاهزية الصفحة، ويُتاح على الكائن العالمي `window.apiClient` لاستخدامه من أي صفحة في الواجهة.

## 4. التحقق من نقاط النهاية (API Endpoints)
بعد تشغيل الخادم يمكنك التحقق يدويًا من بعض المسارات باستخدام المتصفح أو أدوات مثل `curl`:
- `GET /api/health` — للتحقق من جاهزية الخادم.
- `GET /api/auth/csrf-token` — لجلب رمز الحماية (CSRF) المستخدم في أي طلبات تغيير حالة.
- `POST /api/auth/login` — يسجّل الدخول باستخدام JSON يحتوي على `email` و`password` مع تمرير ترويسة `X-CSRF-Token`.
- `GET /api/restaurants` — يعرض قائمة المطاعم النشطة (مع دعم عوامل التصفية عبر معاملات الاستعلام).

جميع الطلبات التي تُغيّر بيانات (POST، PUT، PATCH، DELETE) تُلزم برمز CSRF صالح. في حالة غياب الرمز أو انتهاء صلاحيته ستستقبل استجابة بكود 419 ورسالة توضح المشكلة.

## 5. كيفية عمل الحماية من CSRF
- عند تهيئة `APIClient` يقوم تلقائيًا بطلب `GET /api/auth/csrf-token` وتخزين الرمز في الذاكرة ثم تضمينه في كل طلب مُعدّل.
- بعد نجاح أو فشل أي طلب يعتمد على CSRF، يقوم العميل بتحديث الرمز لضمان صلاحيته للطلب التالي.
- جانب الخادم يتحقق من الرمز في `api/bootstrap.php` قبل تنفيذ أي طلب تغيير، وبالتالي لا حاجة لإضافة منطق إضافي في كل ملف Endpoint.

## 6. اختبار تدفق تسجيل الدخول والتسجيل
1. افتح `http://localhost/e-menu/login.html` وحاول تسجيل الدخول بمستخدم صالح. في حالة نجاح الطلب سيعاد توجيهك إلى لوحة التحكم تحت المسار (`/dashboard/restaurant/index.html`).
2. جرّب صفحة التسجيل `register.html` لإنشاء حساب جديد. يتم إرسال البيانات بصيغة JSON بأسماء الحقول التي تتوقعها الفئات الخلفية (`restaurant_name`, `owner_name`, ...)، وسيتم توجيهك تلقائيًا إلى صفحة تسجيل الدخول بعد نجاح العملية.

## 7. نشر المشروع على خادم إنتاج (Deployment)
- تأكد من ضبط إعدادات البيئة في `config/config.php` (روابط، بريد إلكتروني، إعدادات SMTP، كلمات مرور).
- ارفع المشروع إلى خادم يدعم PHP وApache مع تفعيل `mod_rewrite`.
- أنشئ قاعدة البيانات على الخادم البعيد، واستورد `schema.sql`، ثم حدّث بيانات الاتصال في ملف الإعدادات.
- إذا استُخدم مسار فرعي أو نطاق فرعي، فلن تحتاج لتعديل الواجهة الأمامية بفضل آلية كشف المسار التلقائي، لكن يجب تحديث `APP_URL` لمطابقة العنوان الفعلي.

## 8. اختبار نقاط النهاية عبر Postman
يوفّر Postman واجهة رسومية لتجربة واجهة الـ API خطوة بخطوة. اتبع الإرشادات التالية لإعداد مجموعة محلية:

1. **إنشاء بيئة جديدة**
   - في Postman افتح تبويب *Environments* وأنشئ بيئة باسم `E-Menu Local`.
   - أضف المتغيرين التاليين:
     - `base_url` = `http://localhost/e-menu/api`
     - `csrf_token` (اتركه فارغًا لتحديثه بعد جلب الرمز).

2. **جلب رمز CSRF**
   - أنشئ طلبًا من نوع `GET` إلى `{{base_url}}/auth/csrf-token`.
   - بعد الإرسال، انسخ قيمة الحقل `token` من الاستجابة واحفظها في المتغير `csrf_token` داخل البيئة.

3. **تجربة التسجيل**
   - أنشئ طلب `POST` إلى `{{base_url}}/auth/register`.
   - في تبويب *Headers* أضف `Content-Type: application/json` و`X-CSRF-Token: {{csrf_token}}`.
   - في تبويب *Body* اختر `raw` ثم `JSON` وأدخل نموذج بيانات صالح مثل:
     ```json
     {
       "restaurant_name": "My Bistro",
       "owner_name": "John Doe",
       "email": "owner@example.com",
       "password": "secret123",
       "password_confirm": "secret123",
       "phone": "+966500000000"
     }
     ```
   - إذا أرجعت الاستجابة رمزًا جديدًا ضمن الحقل `csrfToken` أو `token` فحدّث المتغير `csrf_token` به مباشرةً.

4. **تجربة تسجيل الدخول**
   - أنشئ طلب `POST` إلى `{{base_url}}/auth/login` بنفس الرؤوس السابقة، مع جسم JSON يحتوي على البريد وكلمة المرور.

5. **الوصول إلى البيانات المحمية والعامة**
   - استعمل `GET {{base_url}}/restaurants` أو `GET {{base_url}}/restaurant?slug=my-bistro` للاطلاع على البيانات العامة.
   - لأي طلب تعديل (مثل إنشاء مراجعة أو تحديث مطعم) كرر الخطوة 2 لتحديث رمز CSRF قبل الإرسال.

باتباع هذه الخطوات يمكنك إعداد مجموعة Postman تحفظ الرؤوس والمتغيرات، مما يسهل اختبار جميع مسارات الـ API أثناء التطوير.

## 9. استكشاف الأخطاء وإصلاحها
- **أخطاء 404 على `/api/...`**: تأكد من أن الموقع يُخدم من نفس المسار الذي توجد به مجلدات `assets` و`api`. ملفات JavaScript تعتمد على مسارها الفعلي لبناء عنوان الـ API.
- **أخطاء CSRF (حالة 419)**: تحقق من أن الجلسات تعمل وأن جدول `csrf_tokens` موجود في قاعدة البيانات، ثم أعد تحميل الصفحة للسماح للعميل بجلب رمز جديد.
- **أخطاء تسجيل الدخول**: افحص سجل الأخطاء في `logs/` وتأكد من صحة بيانات المستخدم وأن جدول المطاعم يحتوي على سجلات مفعّلة.

باتباع الخطوات السابقة ستحصل على بيئة عمل متكاملة يمكن نقلها إلى خادم حقيقي أو استخدامها في التطوير المحلي.
